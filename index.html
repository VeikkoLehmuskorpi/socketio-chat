<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Socket.IO Chat Example</title>
  </head>
  <body>
    <div id="nicknameDiv">
      <h2>Nickname</h2>
      <form action="" id="nicknameForm">
        <input type="text" required id="nicknameInput" />
        <button>set</button>
      </form>
    </div>

    <h2>Online</h2>
    <ul id="onlineUsers"></ul>

    <h2>Chat</h2>
    <ul id="messages"></ul>
    <form action="" id="messageForm">
      <input type="text" id="messageInput" />
      <button>send</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const nicknameDiv = document.querySelector('#nicknameDiv');
      const nicknameForm = document.querySelector('#nicknameForm');
      const nicknameInput = document.querySelector('#nicknameInput');
      let nickname = 'You';

      nicknameForm.addEventListener('submit', e => {
        e.preventDefault();
        nickname = nicknameInput.value;
        socket.emit('set nickname', nicknameInput.value);
        nicknameDiv.style.display = 'none';
        return false;
      });

      const onlineUsers = document.querySelector('#onlineUsers');

      const messages = document.querySelector('#messages');
      const messageForm = document.querySelector('#messageForm');
      const messageInput = document.querySelector('#messageInput');

      messageForm.addEventListener('submit', e => {
        e.preventDefault();
        socket.emit('chat message', messageInput.value);
        /* Show your own message */
        displayMessage(
          `${nickname} (${getCurrentTime()}): ${messageInput.value}`,
          messages
        );
        resetInputValue(messageInput);
        return false;
      });

      socket.on('chat message', (msg, user, time) => {
        displayMessage(`${user} (${time}): ${msg}`, messages);
      });

      socket.on('chat connect', (user, clients) => {
        displayMessage(`${user} connected`, messages);
      });

      socket.on('chat disconnect', (user, clients) => {
        displayMessage(`${user} disconnected`, messages);
      });

      const displayMessage = (message, parent) => {
        const msgElem = document.createElement('li');
        const msgTextNode = document.createTextNode(message);
        msgElem.appendChild(msgTextNode);
        parent.appendChild(msgElem);
      };

      const displayClients = clients => {
        clients.map(client => displayMessage(client, onlineUsers));
      };

      const getCurrentTime = () => {
        const timestamp = new Date();
        const timeHours =
          timestamp.getHours() < 10
            ? `0${timestamp.getHours()}`
            : timestamp.getHours();
        const timeMinutes =
          timestamp.getMinutes() < 10
            ? `0${timestamp.getMinutes()}`
            : timestamp.getMinutes();
        const timeSeconds =
          timestamp.getSeconds() < 10
            ? `0${timestamp.getSeconds()}`
            : timestamp.getSeconds();
        const formattedTimestamp = `${timeHours}:${timeMinutes}:${timeSeconds}`;
        return formattedTimestamp;
      };

      const resetInputValue = field => (field.value = '');
    </script>
  </body>
</html>
